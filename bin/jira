#!/usr/bin/env python
"""
add credentials to ~/.jira_credentials

echo -e "myname@gomspace.com\nMySuperSecretPassword1234" > ~/.jira_credentials
"""
import requests
import os
import json
import sys
import subprocess


def print_issue(nr, i):
    key = '[ ' + i['key'] + ' ] '
    summary = i['fields']['summary']
    status = i['fields']['status']['statusCategory']['name']
    print "[%2d]%-20s %s  (%s)" % (nr, key, summary, status)


with open(os.path.join(os.environ['HOME'], '.jira_credentials')) as fp:
    spl = fp.read().split('\n')
    user = spl[0]
    pasw = spl[1]
auth = requests.auth.HTTPBasicAuth(user, pasw)

r = requests.get('https://gomspace.atlassian.net/rest/api/2/search?jql=assignee=jjp', auth=auth)
data = json.loads(r.text)

issues = []
for i in data['issues']:
    status = i['fields']['status']['statusCategory']['name']
    if status not in ['Done']:
        issues.append(i)

for nr, i in enumerate(issues):
    print_issue(nr, i)

if 'open' in sys.argv:
    to_open = int(raw_input('Open issue # '))
    url = 'http://gomspace.atlassian.net/browse/%s' % issues[to_open]['key']
    cmd = 'xdg-open %s' % url
    subprocess.check_call(cmd.split())
